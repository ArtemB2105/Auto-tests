name: Tests with Allure

on:
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø—É—à–µ
  push:
    branches: [ main, master ]
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:
    inputs:
      test_type:
        description: '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∑–∞–ø—É—Å–∫–∞'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - api
          - ui
          - specific
      test_path:
        description: '–ü—É—Ç—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ç–µ—Å—Ç—É (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω specific)'
        required: false
        default: ''
        type: string
      python_version:
        description: '–í–µ—Ä—Å–∏—è Python'
        required: false
        default: '3.11'
        type: choice
        options:
          - '3.10'
          - '3.11'
          - '3.12'
      os:
        description: '–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞'
        required: false
        default: 'windows'
        type: choice
        options:
          - windows
          - ubuntu
          - macos

jobs:
  test:
    runs-on: ${{ github.event.inputs.os || 'windows' }}-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üêç Setup Python ${{ github.event.inputs.python_version || '3.11' }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ github.event.inputs.python_version || '3.11' }}
      
      - name: üì¶ Install dependencies
        run: |
          pip install pytest allure-pytest playwright requests
          playwright install chromium
          playwright install-deps
      
      # –£—Å–ª–æ–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      - name: üß™ Run Tests
        id: run_tests
        run: |
          echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ —Ç–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—Ç—å
          TEST_TYPE="${{ github.event.inputs.test_type || 'all' }}"
          
          if [ "$TEST_TYPE" == "all" ]; then
            echo "–ó–∞–ø—É—Å–∫ –í–°–ï–• —Ç–µ—Å—Ç–æ–≤..."
            pytest API_tests/ UI_E2E_tests/ -v --alluredir=allure-results
          
          elif [ "$TEST_TYPE" == "api" ]; then
            echo "–ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ API —Ç–µ—Å—Ç–æ–≤..."
            pytest API_tests/ -v --alluredir=allure-results
          
          elif [ "$TEST_TYPE" == "ui" ]; then
            echo "–ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ UI —Ç–µ—Å—Ç–æ–≤..."
            pytest UI_E2E_tests/ -v --alluredir=allure-results
          
          elif [ "$TEST_TYPE" == "specific" ]; then
            SPECIFIC_PATH="${{ github.event.inputs.test_path }}"
            if [ -n "$SPECIFIC_PATH" ]; then
              echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø–æ –ø—É—Ç–∏: $SPECIFIC_PATH"
              pytest "$SPECIFIC_PATH" -v --alluredir=allure-results
            else
              echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω –ø—É—Ç—å –∫ —Ç–µ—Å—Ç—É"
              exit 1
            fi
          fi
      
      - name: üìä Generate Allure Report
        if: always()
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Allure CLI
          pip install allure-python-commons
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
          allure generate allure-results -o allure-report --clean
      
      - name: üì§ Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ github.run_id }}
          path: allure-results/
      
      - name: üåê Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.run_id }}
          path: allure-report/
      
      # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –î–µ–ø–ª–æ–π –æ—Ç—á–µ—Ç–∞ –Ω–∞ Netlify
      - name: üöÄ Deploy to Netlify (Optional)
        if: success() && github.event_name == 'workflow_dispatch'
        uses: nwtgck/actions-netlify@v2.0
        with:
          publish-dir: './allure-report'
          production-branch: main
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
