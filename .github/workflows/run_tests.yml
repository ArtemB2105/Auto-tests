name: UI E2E Tests with Allure Report

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-and-deploy-report:
    runs-on: windows-latest  # Запускаем на Windows
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pytest allure-pytest playwright
          playwright install chromium

      - name: Run tests with Allure
        run: |
          pytest UI_E2E_tests/Test_main.py -v --alluredir=allure-results

      - name: Install Allure on Windows
        run: |
          # Скачиваем и устанавливаем Allure для Windows
          $url = "https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.zip"
          Invoke-WebRequest -Uri $url -OutFile "allure.zip"
          Expand-Archive -Path "allure.zip" -DestinationPath "allure" -Force
          # Добавляем Allure в PATH
          $allurePath = "$(pwd)\allure\allure-2.29.0\bin"
          echo "ALLURE_PATH=$allurePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$allurePath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Generate Allure HTML report
        if: always()
        run: |
          # Проверяем, что Allure установлен
          allure --version
          # Генерируем отчет
          allure generate allure-results --clean -o allure-report
          echo "Отчёт сгенерирован в allure-report/"

      - name: Debug - Check files
        run: |
          echo "Проверяем файлы:"
          dir allure-results
          echo "---"
          dir allure-report
          if (Test-Path "allure-report\index.html") {
            echo "✅ index.html найден!"
          } else {
            echo "❌ index.html не найден!"
          }

      - name: Deploy report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          keep_files: false
